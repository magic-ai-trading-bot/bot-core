# Development Dockerfile for Rust Core Engine with hot reload (Lightweight)
FROM rust:alpine AS base

# Install dependencies
RUN apk add --no-cache \
    musl-dev \
    libressl-dev \
    pkgconfig \
    curl \
    && rm -rf /var/cache/apk/*

# Set build environment variables to avoid I/O errors
ENV CARGO_NET_GIT_FETCH_WITH_CLI=true
ENV RUSTFLAGS="-C target-feature=-crt-static"

# Development stage
FROM base AS development

# Create app user
RUN addgroup -g 1001 appuser && adduser -u 1001 -G appuser -s /bin/sh -D appuser

# Set working directory
WORKDIR /app

# Copy Cargo files first (for better caching)
COPY Cargo.toml Cargo.lock ./

# Create a dummy src/main.rs to build dependencies
RUN mkdir src && echo "fn main() {}" > src/main.rs

# Build dependencies (cached layer) with minimal flags
RUN cargo build --release --bin binance-trading-bot 2>/dev/null || true

# Remove dummy main.rs
RUN rm src/main.rs

# Copy source code
COPY src ./src
COPY config.toml ./config.toml

# Set environment variables for development
ENV RUST_LOG=debug
ENV RUST_BACKTRACE=1

# Create directories that will be mounted
RUN mkdir -p /app/src /app/data /app/logs

# For development, run as root to avoid permission issues
# USER appuser

# Expose port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/api/health || exit 1

# Development command without cargo-watch to avoid I/O issues
# Simple development mode - manual restart needed
CMD ["sh", "-c", "while true; do cargo run --bin binance-trading-bot; echo 'Restarting in 2 seconds...'; sleep 2; done"] 
# STRATEGIES.md - Deep Trading System Knowledge
# Auto-generated by sync-openclaw-knowledge.sh — DO NOT EDIT MANUALLY

## Strategy Signal Generation

### 1. RSI Strategy (Period: 14, Multi-timeframe: 5M + 15M)

| Signal | Condition | Confidence |
|--------|-----------|------------|
| **Strong BUY** | RSI5m ≤ 20.0 AND RSI15m ≤ 25.0 AND RSI recovering (prev < current) | 0.87 |
| **Strong SELL** | RSI5m ≥ 80.0 AND RSI15m ≥ 75.0 AND RSI declining | 0.87 |
| **Moderate BUY** | RSI5m ≤ 25.0 AND RSI15m < 50 AND RSI recovering | 0.73 |
| **Moderate SELL** | RSI5m ≥ 75.0 AND RSI15m > 50 AND RSI declining | 0.73 |
| **Weak BUY** | RSI5m 25.0-50 AND rising AND RSI15m < 50 | 0.51 |
| **Weak SELL** | RSI5m 50-75.0 AND falling AND RSI15m > 50 | 0.51 |

**Win rate**: 65%
**Common failure**: RSI oversold ≠ immediate bounce trong bear trend. Cần confirm trend reversal trước.

### 2. MACD Strategy (Fast: 12, Slow: 26, Signal: 9)

| Signal | Condition | Confidence |
|--------|-----------|------------|
| **Strong BUY** | Bullish crossover + histogram15m > 0.001 + both increasing | 0.89 |
| **Strong SELL** | Bearish crossover + histogram15m < -0.001 + both decreasing | 0.89 |
| **Moderate BUY** | Crossover + 15M histogram increasing, OR both histograms positive + increasing | 0.71 |
| **Moderate SELL** | Crossover + 15M decreasing, OR both negative + decreasing | 0.71 |
| **Weak BUY** | histogram5m increasing AND MACD > Signal AND momentum growing >10% | 0.55 |

**Win rate**: 61%
**Key**: Crossover = prev_MACD ≤ prev_Signal AND current_MACD > current_Signal

### 3. Bollinger Bands Strategy (Period: 20, StdDev: 2.0)

| Signal | Condition | Confidence |
|--------|-----------|------------|
| **Squeeze Breakout BUY** | Squeeze (BB width < 2.00%) + expanding + price > upper + 15M position > 0.5 | 0.87 |
| **Mean Reversion BUY** | BB position ≤ 0.1 + 15M position < 0.3 + NOT expanding | 0.73 |
| **Trend Continuation BUY** | BB position > 0.8 + 15M > 0.6 + expanding | 0.69 |
| **Moderate BUY** | BB position < 0.25 + price > 15M middle band | 0.58 |

**Win rate**: 63%
**BB Position** = (Price - Lower) / (Upper - Lower). 0 = at lower band, 1 = at upper band.

### 4. Volume Strategy (SMA Period: 20, Spike: 2.0x)

| Signal | Condition | Confidence |
|--------|-----------|------------|
| **Strong Volume Surge BUY** | Volume spike (≥2.0x avg) + bullish ratio ≥ 0.7 + price > POC | 0.91 |
| **Accumulation BUY** | High volume (≥1.5x) + bullish ratio ≥ 0.6, OR near POC + ratio ≥ 0.65 | 0.71 |
| **Weak BUY** | Bullish ratio ≥ 0.55 + volume > 1.2x avg | 0.51 |

**Win rate**: 58%
**POC** = Point of Control (price level with highest trading volume in 20 periods)

### 5. Stochastic Oscillator Strategy (K Period: 14, D Period: 3, Multi-timeframe: 5M + 15M)

| Signal | Condition | Confidence |
|--------|-----------|------------|
| **Strong BUY** | Bullish crossover (%K crosses above %D) + K5m ≤ 15.0 + K15m ≤ 15.0 | 0.89 |
| **Extreme BUY** | K5m ≤ 10.0 (extreme oversold) + K15m ≤ 15.0 + K5m > D5m | 0.85 |
| **Strong SELL** | Bearish crossover (%K crosses below %D) + K5m ≥ 85.0 + K15m ≥ 85.0 | 0.89 |
| **Extreme SELL** | K5m ≥ 90.0 (extreme overbought) + K15m ≥ 85.0 + K5m < D5m | 0.85 |
| **Moderate BUY** | Bullish crossover + K5m ≤ 15.0+10 + K15m < 50 | 0.72 |
| **Moderate SELL** | Bearish crossover + K5m ≥ 85.0-10 + K15m > 50 | 0.72 |
| **Weak BUY** | K5m > D5m + K5m < 50 + K15m < 50 + K rising | 0.52 |
| **Weak SELL** | K5m < D5m + K5m > 50 + K15m > 50 + K falling | 0.52 |

**Win rate**: 64%
**Thresholds**: Oversold = 15.0, Overbought = 85.0, Extreme = 10.0/90.0
**Common failure**: Stochastic crossover trong sideways market tạo nhiều false signals. Cần confirm với volume hoặc trend.

---

## Strategy Orchestration

- **5 strategies** run in parallel: RSI, MACD, Bollinger, Volume, Stochastic
- **Minimum agreement**: 4/5 strategies must agree on direction
- **Combination modes**: WeightedAverage (default), Consensus, BestConfidence, Conservative
- **Multi-timeframe**: Signal loop uses 5M + 15M candles, strategy input includes 1H for volume context
- **Minimum data**: 50 candles per timeframe required before trading starts
- **Hybrid filter**: Optional AI trend filter for additional validation

### Signal Pipeline (order of checks)

1. **Neutral filter**: Skip neutral signals
2. **Confidence filter**: Skip if confidence < min_confidence (0.60)
3. **Short-only mode filter** *(NEW 2026-02-24)*: If `risk.short_only_mode = true` → block ALL Long signals
4. **Choppy market filter**: Skip if 4+ direction flips in 15 minutes for the symbol
5. **Signal confirmation**: Require 2 consecutive same-direction signals within 10 minutes (60s dedup)
6. **AI bias check**: Stricter for Longs (threshold -0.3) vs Shorts (threshold -0.5). Skip if `signal_dir × direction_bias < threshold`
7. **Trade execution**: Pass through risk management layers → execute trade

**Note on step 6**: Long signals blocked when bias even mildly bearish (> -0.3). Short signals only blocked when bias mildly bullish (< 0.5). This asymmetry protects against losing Long trades in bearish markets.

### Choppy Market Detection

Prevents trading in ranging/whipsaw markets:
- Tracks all non-neutral signals per symbol with timestamps
- Counts direction changes (Long→Short or Short→Long) in 15-min window
- If ≥4 flips → market is choppy → block ALL signals for that symbol
- Example: `[Long, Long, Short, Long, Short, Long]` = 4 flips → BLOCKED
- Window auto-cleans entries >15 minutes old
- Common trigger: ETH flipping Long↔Short every 5-10 minutes

---

## Risk Management - 7 Protection Layers

### Layer 1: Position Size Control
- **Limit**: ≤2.0% equity per trade
- **Purpose**: Giới hạn số vốn bỏ vào mỗi trade
- **Calculation**: risk_amount = equity × position_size_pct / 100

### Layer 2: Stop Loss
- **Default**: 5.0% per trade
- **Purpose**: Tự động đóng lệnh khi giá đi ngược quá mức
- **Calculation**: LONG: entry × (1 - 5.0/100), SHORT: entry × (1 + 5.0/100)

### Layer 3: Portfolio Risk Limit
- **Limit**: ≤10.0% total portfolio risk
- **Calculation**: Σ(position_value × stop_loss_distance%) / equity
- **When hit**: Blocks ALL new trades

### Layer 4: Daily Loss Limit
- **Limit**: 3.0% of daily starting equity
- **When hit**: ALL trading stops for rest of day
- **Reset**: Next calendar day (UTC)

### Layer 5: Consecutive Losses Tracking
- **Limit**: 3 consecutive losses max
- **When hit**: Triggers cool-down (Layer 6)
- **Reset**: Counter → 0 on first profitable trade

### Layer 6: Cool-Down Mechanism
- **Trigger**: 3 consecutive losses
- **Duration**: 60 minutes block on ALL new trades
- **Reset**: Automatic after 60 min

### Layer 7: Position Correlation Control
- **Limit**: Max 70% exposure in one direction
- **Calculation**: long_exposure / total_exposure
- **Minimum threshold**: Correlation check **skipped when < 3 open positions** (with 1-2 positions, ratio is always 50-100% which would incorrectly block same-direction trades)
- **When hit (3+ positions)**: Blocks new trades that increase concentration

**Execution order**: Daily Loss → Cool-Down → Correlation → Portfolio Risk → Position Size + Stop Loss → Execute

---

## Execution Simulation

| Feature | Default | Detail |
|---------|---------|--------|
| **Slippage** | ON (0.05% max) | BUY: price × (1 + slippage%), SELL: price × (1 - slippage%) |
| **Execution Delay** | 100ms | Simulates network latency, re-fetches price after delay |
| **Market Impact** | OFF | impact = (order_value / typical_volume) × factor, capped 1% |
| **Partial Fills** | OFF | 10% chance, fills 30-90% of order |

---

## Common Loss Patterns & Solutions

| Pattern | Symptoms | Solution |
|---------|----------|----------|
| **False breakout** | Entry on Bollinger squeeze breakout, reverses | Wait for volume confirmation |
| **Counter-trend entry** | RSI oversold BUY in strong downtrend | Add EMA 50/200 trend filter |
| **Overtrading** | >20 trades/day, many small losses | Increase confidence threshold |
| **Late entry** | Enter after majority of move | Check MACD histogram declining = late |
| **Stop loss too tight** | Many -5.0% losses that recover | Widen based on ATR (1.5-2x) |
| **Correlated positions** | Same-direction trades lose together | Check correlation limit |
| **Cool-down panic** | Force trades after cool-down | Extend cool-down, reduce size |
| **Volume dry-up** | Low volume, high slippage | Skip signals volume < 0.8x avg |
| **Stochastic whipsaw** | Crossovers in sideways market | Combine with volume/trend filter |
| **Choppy market** | Signal flips Long↔Short every 5-10 min | Engine auto-blocks at 4+ flips/15min (built-in) |

---

## Key Configuration Defaults

```
Risk (7 layers + market regime):
  position_size_pct: 2.0%
  stop_loss_pct: 5.0% PnL (= 0.5% price @10x leverage)
  take_profit_pct: 20.0% PnL (= 2.0% price @10x leverage)
  max_portfolio_risk: 10.0%
  daily_loss_limit: 3.0%
  max_consecutive_losses: 3
  cool_down_minutes: 60
  correlation_limit: 70% (only enforced with 3+ open positions)
  short_only_mode: true (NEW - blocks ALL Long signals in bearish markets)

Strategy:
  active_strategies: 5 (RSI, MACD, Bollinger, Volume, Stochastic)
  min_strategies_agreement: 4/5
  min_confidence: 0.60
  confidence_threshold: 0.75 (tuned by self-tuning)
  min_required_timeframes: 4/4 (tuned by self-tuning)
  min_required_indicators: 4/5 (tuned by self-tuning)
  signal_confirmation: 2 consecutive same-direction signals within 10min
  choppy_market_threshold: 4 direction flips in 15min → block trading
  signal_interval: 5 min

AI Bias Filter:
  long_conflict_threshold: -0.3 (stricter - blocks Longs in mildly bearish)
  short_conflict_threshold: -0.5 (standard)

Execution:
  slippage: ON (0.05% max)
  delay: 100ms
  market_impact: OFF
  partial_fills: OFF

Auto-Analysis (NEW):
  losing_trade_analysis: ON (xAI Grok analyzes all losing trades automatically)
  collection: trade_analyses (MongoDB)
```

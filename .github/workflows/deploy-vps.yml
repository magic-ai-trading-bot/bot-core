name: Deploy to VPS

on:
  # Trigger after test-coverage workflow completes successfully
  workflow_run:
    workflows: ["Test Coverage & Quality Gates"]
    types:
      - completed
    branches: [main]

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if tests not run'
        required: false
        default: 'false'
        type: boolean

# Ensure only one deployment runs at a time
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    # Only deploy if:
    # 1. Manual trigger with force_deploy, OR
    # 2. Workflow run completed successfully
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check deployment conditions
        id: check
        run: |
          echo "ğŸš€ Deployment triggered"
          echo "Event: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "Workflow: ${{ github.event.workflow_run.name }}"
            echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
            echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          fi

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          echo "ğŸ” Connecting to VPS..."

          # Create deploy script
          cat > deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e

          echo "ğŸ“¦ Pulling latest code..."
          cd /root/bot-core
          git fetch origin main
          git reset --hard origin/main

          echo "ğŸ§¹ AGGRESSIVE Docker cleanup to free disk space..."
          # Stop all containers first to allow full cleanup
          docker-compose --profile prod down || true

          # Remove ALL stopped containers
          docker container prune -f || true

          # Remove ALL unused images (keeps nothing!)
          docker image prune -a -f || true

          # Remove ALL unused volumes (careful: this removes data volumes too)
          # Only prune anonymous volumes, keep named ones
          docker volume ls -qf dangling=true | xargs -r docker volume rm || true

          # Remove ALL build cache
          docker builder prune -a -f || true

          # Show disk usage after cleanup
          echo "ğŸ“Š Disk usage after cleanup:"
          df -h /
          docker system df

          echo "ğŸ”¨ Building services (this may take a while on first build)..."
          docker-compose --profile prod build --no-cache rust-core-engine nextjs-ui-dashboard python-ai-service

          echo "ğŸ”„ Starting all services..."
          docker-compose --profile prod up -d

          echo "â³ Waiting for services to be healthy..."
          sleep 30

          echo "âœ… Checking service health..."
          docker ps --format "table {{.Names}}\t{{.Status}}"

          # Verify health
          if curl -sf http://localhost:8080/api/health > /dev/null; then
            echo "âœ… Rust API healthy"
          else
            echo "âŒ Rust API unhealthy"
            exit 1
          fi

          if curl -sf http://localhost:8000/health > /dev/null; then
            echo "âœ… Python AI healthy"
          else
            echo "âŒ Python AI unhealthy"
            exit 1
          fi

          if curl -sf http://localhost:3000 > /dev/null; then
            echo "âœ… Frontend healthy"
          else
            echo "âŒ Frontend unhealthy"
            exit 1
          fi

          # Final cleanup - remove old images after successful deploy
          echo "ğŸ§¹ Final cleanup - removing old images..."
          docker image prune -a -f || true
          docker builder prune -f || true

          echo ""
          echo "ğŸ“Š Final disk usage:"
          df -h /

          echo ""
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸ“Š Dashboard: http://$(curl -s ifconfig.me):3000"
          DEPLOY_SCRIPT

          # Execute deploy script on VPS
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" 'bash -s' < deploy.sh

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to production successful!"
          else
            echo "âŒ Deployment failed!"
          fi

      - name: Create deployment summary
        if: success()
        run: |
          echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | http://${{ secrets.VPS_HOST }}:3000 | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust API | http://${{ secrets.VPS_HOST }}:8080 | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Python AI | http://${{ secrets.VPS_HOST }}:8000 | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY

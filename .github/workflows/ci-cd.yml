name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  issues: write
  pull-requests: write
  statuses: write
  checks: write

env:
  RUST_COVERAGE_THRESHOLD: 90.0
  PYTHON_COVERAGE_THRESHOLD: 93.0
  FRONTEND_COVERAGE_THRESHOLD: 90.0

jobs:
  # Stage 1: Validation
  validate:
    name: Environment & Pre-flight Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate environment variables
        run: |
          echo "Checking for required files..."
          [ -f .env.example ] || { echo "Missing .env.example"; exit 1; }
          [ -f docker-compose.yml ] || [ -L docker-compose.yml ] || { echo "Missing docker-compose.yml"; exit 1; }
          [ -f Makefile ] || { echo "Missing Makefile"; exit 1; }
          echo "âœ“ All required files present"

      - name: Validate Docker configuration
        run: |
          echo "Checking docker-compose.yml..."
          if [ -L docker-compose.yml ]; then
            echo "âœ“ docker-compose.yml is a symlink"
            REAL_FILE=$(readlink -f docker-compose.yml 2>/dev/null || readlink docker-compose.yml)
            echo "  â†’ Points to: $REAL_FILE"
            if [ -f "$REAL_FILE" ]; then
              echo "âœ“ Target file exists"
            else
              echo "âœ— Target file does not exist: $REAL_FILE"
              exit 1
            fi
          elif [ -f docker-compose.yml ]; then
            echo "âœ“ docker-compose.yml is a regular file"
          else
            echo "âœ— docker-compose.yml not found"
            exit 1
          fi

          echo "Validating docker-compose configuration..."
          # Use Docker Compose V2 (docker compose, not docker-compose)
          docker compose config > /dev/null 2>&1 || {
            echo "âœ— Invalid docker-compose.yml - showing errors:"
            docker compose config
            exit 1
          }
          echo "âœ“ Docker Compose configuration valid"

      - name: Check for secrets in code (PR)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

      - name: Check for secrets in code (Push with changes)
        if: github.event_name == 'push' && github.event.before != '0000000000000000000000000000000000000000' && github.event.before != github.sha
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          extra_args: --only-verified

      - name: Check for secrets in code (Full scan)
        if: (github.event_name == 'push' && (github.event.before == '0000000000000000000000000000000000000000' || github.event.before == github.sha)) || github.event_name == 'workflow_dispatch'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified --since-commit="" --max-depth=1000

  # Stage 2: Build & Test
  build-and-test:
    name: Build & Test All Services
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        service: [rust, python, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: false

      - name: Setup Rust
        if: matrix.service == 'rust'
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Setup Python
        if: matrix.service == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        if: matrix.service == 'frontend'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        if: matrix.service == 'frontend'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cache/pip
            node_modules
          key: ${{ runner.os }}-${{ matrix.service }}-${{ hashFiles('**/Cargo.lock', '**/requirements*.txt', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.service }}-

      - name: Lint - Rust
        if: matrix.service == 'rust'
        working-directory: ./rust-core-engine
        run: |
          cargo fmt -- --check
          cargo clippy -- -D warnings -A clippy::too_many_arguments

      - name: Lint - Python
        if: matrix.service == 'python'
        working-directory: ./python-ai-service
        run: |
          pip install flake8 black isort mypy
          black --check . || true
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Lint - Frontend
        if: matrix.service == 'frontend'
        working-directory: ./nextjs-ui-dashboard
        run: |
          bun install
          bun run lint || true

      - name: Test - Rust
        if: matrix.service == 'rust'
        working-directory: ./rust-core-engine
        run: |
          cargo test --all --verbose -- --test-threads=1

      - name: Test - Python
        if: matrix.service == 'python'
        working-directory: ./python-ai-service
        run: |
          pip install -r requirements-ci.txt
          pip install pytest pytest-cov
          pytest --cov --cov-config=.coveragerc --cov-report=xml --cov-report=term-missing \
            --ignore=tests/test_ml_compatibility.py \
            --ignore=tests/test_ml_performance.py \
            -v

      - name: Test - Frontend
        if: matrix.service == 'frontend'
        working-directory: ./nextjs-ui-dashboard
        run: |
          bun install
          npm run test:coverage || true

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: |
            ./rust-core-engine/coverage/cobertura.xml
            ./python-ai-service/coverage.xml
            ./nextjs-ui-dashboard/coverage/coverage-final.json
          flags: ${{ matrix.service }}
          fail_ci_if_error: false

  # Stage 3: Security Scanning
  security:
    name: Security Scanning
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results
          path: trivy-results.sarif
          retention-days: 30

      - name: Dependency check
        run: |
          echo "Running dependency checks..."
          # Rust
          cd rust-core-engine
          cargo install cargo-audit || true
          cargo audit || true
          cd ..

          # Python
          cd python-ai-service
          pip install safety
          safety check -r requirements.txt --json || true
          cd ..

  # Stage 4: Build Docker Images
  build-images:
    name: Build Docker Images
    needs: [build-and-test, security]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Rust image
        uses: docker/build-push-action@v5
        with:
          context: ./rust-core-engine
          push: false
          tags: bot-core/rust-engine:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Python image
        uses: docker/build-push-action@v5
        with:
          context: ./python-ai-service
          file: ./python-ai-service/Dockerfile.ci  # Use lightweight CI Dockerfile (no TensorFlow/PyTorch)
          push: false
          tags: bot-core/python-ai:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./nextjs-ui-dashboard
          push: false
          tags: bot-core/frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Stage 5: Integration Tests
  integration-tests:
    name: Integration Tests
    needs: build-images
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: testpassword

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test .env
        run: |
          cat > .env << EOF
          NODE_ENV=test
          DATABASE_URL=mongodb://admin:testpassword@localhost:27017/test?authSource=admin
          BINANCE_API_KEY=test_key_$(openssl rand -hex 32)
          BINANCE_SECRET_KEY=test_secret_$(openssl rand -hex 32)
          INTER_SERVICE_TOKEN=$(openssl rand -hex 32)
          RUST_API_KEY=$(openssl rand -hex 32)
          PYTHON_API_KEY=$(openssl rand -hex 32)
          JWT_SECRET=$(openssl rand -hex 64)
          DASHBOARD_SESSION_SECRET=$(openssl rand -hex 32)
          BINANCE_TESTNET=true
          TRADING_ENABLED=false
          EOF

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          # Add integration test commands here

  # Stage 6: Deployment (Manual Approval Required for Production)
  deploy:
    name: Deploy to ${{ github.event.inputs.deploy_environment || 'staging' }}
    needs: [integration-tests]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.deploy_environment || 'staging' }}
      url: https://${{ github.event.inputs.deploy_environment || 'staging' }}.bot-core.example.com
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup deployment environment
        run: |
          echo "Deploying to ${{ github.event.inputs.deploy_environment || 'staging' }}"
          # Add deployment setup commands

      - name: Pre-deployment validation
        run: |
          chmod +x scripts/pre-deployment-check.sh
          # ./scripts/pre-deployment-check.sh

      - name: Deploy services
        run: |
          echo "Deploying services..."
          # Add actual deployment commands here
          # Example: ./scripts/deploy-local.sh

      - name: Post-deployment health check
        run: |
          chmod +x scripts/health-check.sh
          # ./scripts/health-check.sh

      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}';
            const environment = '${{ github.event.inputs.deploy_environment || 'staging' }}';
            const message = `ðŸš€ Deployment to **${environment}** ${status === 'success' ? 'âœ… succeeded' : 'âŒ failed'}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  # Stage 7: Rollback (on failure)
  rollback:
    name: Rollback Deployment
    needs: deploy
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute rollback
        run: |
          chmod +x scripts/rollback.sh
          echo "Rollback would be executed here"
          # ./scripts/rollback.sh

      - name: Notify rollback
        uses: actions/github-script@v6
        with:
          script: |
            const environment = '${{ github.event.inputs.deploy_environment || 'staging' }}';
            const message = `âš ï¸ Automatic rollback initiated for **${environment}** deployment`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  # Final Stage: Reporting
  report:
    name: Generate CI/CD Report
    needs: [build-and-test, security, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate report
        run: |
          echo "# CI/CD Pipeline Report" > report.md
          echo "" >> report.md
          echo "**Workflow:** ${{ github.workflow }}" >> report.md
          echo "**Run:** #${{ github.run_number }}" >> report.md
          echo "**Commit:** ${{ github.sha }}" >> report.md
          echo "**Branch:** ${{ github.ref_name }}" >> report.md
          echo "" >> report.md
          echo "## Job Status" >> report.md
          echo "- Validation: ${{ needs.validate.result || 'N/A' }}" >> report.md
          echo "- Build & Test: ${{ needs.build-and-test.result || 'N/A' }}" >> report.md
          echo "- Security: ${{ needs.security.result || 'N/A' }}" >> report.md
          echo "- Integration Tests: ${{ needs.integration-tests.result || 'N/A' }}" >> report.md
          echo "" >> report.md
          echo "Generated at: $(date)" >> report.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: ci-cd-report
          path: report.md
          retention-days: 30

      - name: Comment PR with report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

name: Rust Core Engine Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'rust-core-engine/**'
      - '.github/workflows/rust-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'rust-core-engine/**'
      - '.github/workflows/rust-tests.yml'

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: 'stable'

jobs:
  # Linting and formatting check (runs first, fast fail)
  rust-lint:
    runs-on: ubuntu-latest
    name: Rust Lint & Format

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true
        components: rustfmt, clippy

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          rust-core-engine/target
        key: ${{ runner.os }}-cargo-lint-v2-${{ hashFiles('rust-core-engine/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-lint-v2-

    - name: Check Rust formatting
      run: |
        cd rust-core-engine
        cargo fmt -- --check

    - name: Run Clippy
      run: |
        cd rust-core-engine
        cargo clippy --all-targets --all-features -- -D warnings \
          -A clippy::len_zero \
          -A clippy::approx_constant \
          -A clippy::field_reassign_with_default \
          -A clippy::assertions_on_constants \
          -A clippy::manual_is_ascii_check \
          -A clippy::manual_range_contains \
          -A clippy::useless_vec \
          -A clippy::redundant_clone \
          -A clippy::needless_late_init \
          -A clippy::bool_assert_comparison \
          -A clippy::unnecessary_to_owned

  # Parallel test execution split into 8 jobs to avoid timeout
  rust-tests:
    runs-on: ubuntu-latest
    name: Rust Tests (${{ matrix.test-group }})
    needs: rust-lint

    strategy:
      fail-fast: false
      matrix:
        test-group:
          - 'config'
          - 'auth-ai'
          - 'binance'
          - 'market-data'
          - 'indicators'
          - 'trading-paper'
          - 'strategies-position'
          - 'integration-services'

    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          rust-core-engine/target
        key: ${{ runner.os }}-cargo-v2-${{ matrix.test-group }}-${{ hashFiles('rust-core-engine/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-v2-${{ matrix.test-group }}-
          ${{ runner.os }}-cargo-v2-

    - name: Build project
      run: |
        cd rust-core-engine
        cargo build --tests --verbose

    - name: Run test group - ${{ matrix.test-group }}
      env:
        DATABASE_URL: mongodb://root:password@localhost:27017/test_trading_bot
        JWT_SECRET: test_jwt_secret_key_for_testing_only_do_not_use_in_production
        BINANCE_TESTNET: true
        TRADING_ENABLED: false
      run: |
        cd rust-core-engine

        # Run specific test group based on matrix (8 parallel jobs)
        case "${{ matrix.test-group }}" in
          config)
            echo "Running config tests (67 tests)..."
            cargo test --test test_config --no-fail-fast -- --test-threads=2
            ;;
          auth-ai)
            echo "Running auth and AI tests (57 tests)..."
            cargo test --test test_auth --no-fail-fast -- --test-threads=2
            cargo test --test test_ai --no-fail-fast -- --test-threads=2
            ;;
          binance)
            echo "Running Binance client tests (36 tests)..."
            cargo test --test test_binance_client --no-fail-fast -- --test-threads=2
            ;;
          market-data)
            echo "Running market data tests (45 tests)..."
            cargo test --test test_market_data --no-fail-fast -- --test-threads=2
            ;;
          indicators)
            echo "Running indicators tests (35 tests)..."
            cargo test --test test_indicators_comprehensive --no-fail-fast -- --test-threads=2
            ;;
          trading-paper)
            echo "Running trading and paper trading tests (28 tests)..."
            cargo test --test test_trading --no-fail-fast -- --test-threads=2
            cargo test --test test_paper_trading --no-fail-fast -- --test-threads=2
            ;;
          strategies-position)
            echo "Running strategies and position risk tests (34 tests)..."
            cargo test --test test_strategies --no-fail-fast -- --test-threads=2
            cargo test --test test_position_risk_comprehensive --no-fail-fast -- --test-threads=2
            ;;
          integration-services)
            echo "Running integration and service tests (32 tests)..."
            cargo test --test test_service_integration --no-fail-fast -- --test-threads=2
            cargo test --test test_websocket --no-fail-fast -- --test-threads=2
            cargo test --test test_storage --no-fail-fast -- --test-threads=2
            cargo test --test test_cross_service --no-fail-fast -- --test-threads=2
            ;;
        esac

  # Coverage job (runs after all test groups complete)
  rust-coverage:
    runs-on: ubuntu-latest
    name: Rust Test Coverage
    needs: rust-tests

    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Free up disk space
      uses: jlumbroso/free-disk-space@main
      with:
        # Optimized for speed and space
        # Keep tool-cache to avoid re-downloading
        tool-cache: false
        # Fast removals (most space gained)
        android: true        # ~12GB, fast
        dotnet: true         # ~2GB, fast
        haskell: true        # ~2GB, fast
        # Skip slow operations
        large-packages: false  # Slow, only ~1GB
        docker-images: true    # ~2GB, medium speed
        swap-storage: false    # Slow, not needed

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true

    # Cache disabled for coverage job to avoid timeout issues
    # Coverage builds are already fast enough without caching (~3-5 min)
    # - name: Cache Rust dependencies
    #   uses: actions/cache@v4
    #   continue-on-error: true
    #   with:
    #     path: |
    #       ~/.cargo/registry
    #       ~/.cargo/git
    #     key: ${{ runner.os }}-cargo-coverage-v3-${{ hashFiles('rust-core-engine/Cargo.lock') }}

    - name: Install llvm-tools and cargo-llvm-cov
      run: |
        rustup component add llvm-tools-preview
        cargo install cargo-llvm-cov

    - name: Run tests with coverage
      timeout-minutes: 30
      env:
        DATABASE_URL: mongodb://root:password@localhost:27017/test_trading_bot
        JWT_SECRET: test_jwt_secret_key_for_testing_only_do_not_use_in_production
        BINANCE_TESTNET: true
        TRADING_ENABLED: false
      run: |
        cd rust-core-engine
        # Run tests with llvm-cov (much faster than tarpaulin)
        cargo llvm-cov --lib --lcov --output-path coverage.lcov
        cargo llvm-cov report

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: rust-core-engine/coverage.lcov
        flags: rust
        name: rust-core-engine-coverage
        fail_ci_if_error: false

    # Temporarily disabled due to artifact storage quota
    # - name: Archive coverage reports
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: rust-coverage-report
    #     path: rust-core-engine/target/tarpaulin/

    # Temporarily disabled due to artifact storage quota
    # - name: Archive test results
    #   uses: actions/upload-artifact@v4
    #   if: always()
    #   with:
    #     name: rust-test-results
    #     path: rust-core-engine/target/

  rust-security:
    runs-on: ubuntu-latest
    name: Rust Security Audit
    needs: rust-coverage

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: ${{ runner.os }}-cargo-audit-v2-${{ hashFiles('rust-core-engine/Cargo.lock') }}

    - name: Install cargo-audit
      run: cargo install cargo-audit

    - name: Run security audit
      run: |
        cd rust-core-engine
        cargo audit --json

    - name: Install cargo-deny
      run: cargo install cargo-deny --version 0.18.3

    - name: Run cargo-deny check
      run: |
        cd rust-core-engine
        cargo deny check advisories

  rust-benchmark:
    runs-on: ubuntu-latest
    name: Rust Performance Benchmarks
    needs: rust-coverage
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          rust-core-engine/target
        key: ${{ runner.os }}-cargo-bench-v2-${{ hashFiles('rust-core-engine/Cargo.lock') }}

    - name: Run benchmarks
      run: |
        cd rust-core-engine
        cargo bench

    # Temporarily disabled due to artifact storage quota
    # - name: Archive benchmark results
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: rust-benchmark-results
    #     path: rust-core-engine/target/criterion/
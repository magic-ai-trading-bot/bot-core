# @spec:ARCH-OVERVIEW-001 - Service Architecture
# @ref:specs/02-design/2.1-architecture/ARCH-OVERVIEW.md
# Upstream Configuration for Bot-Core Services

# Frontend (Next.js Dashboard)
upstream frontend {
    least_conn;  # Load balancing algorithm
    server nextjs-ui-dashboard:3000 max_fails=3 fail_timeout=30s;
    # Add more replicas for production
    # server nextjs-ui-dashboard-2:3000 max_fails=3 fail_timeout=30s;
    # server nextjs-ui-dashboard-3:3000 max_fails=3 fail_timeout=30s;

    keepalive 32;  # Connection pool
}

# Rust Core Engine API
upstream rust_api {
    least_conn;
    server rust-core-engine:8080 max_fails=3 fail_timeout=30s;
    # Add more replicas for production
    # server rust-core-engine-2:8080 max_fails=3 fail_timeout=30s;
    # server rust-core-engine-3:8080 max_fails=3 fail_timeout=30s;

    keepalive 64;  # Higher connection pool for API
}

# Python AI Service
upstream python_api {
    least_conn;
    server python-ai-service:8000 max_fails=3 fail_timeout=30s;
    # Add more replicas for production
    # server python-ai-service-2:8000 max_fails=3 fail_timeout=30s;
    # server python-ai-service-3:8000 max_fails=3 fail_timeout=30s;

    keepalive 32;
}

# Upstream configuration options:
# - least_conn: Least connections load balancing
# - max_fails: Maximum failed attempts before marking server down
# - fail_timeout: Time to wait before retrying failed server
# - keepalive: Number of idle keepalive connections
